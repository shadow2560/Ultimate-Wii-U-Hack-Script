Setlocal enabledelayedexpansion
chcp 65001 > nul
::Script by Shadow256

IF NOT EXIST templogs\*.* (
	del /q templogs 2>nul
	mkdir templogs
)
:set_choose_exploit
echo Ce script va vous permettre de lancer simplement un serveur hébergeant l'exploit du navigateur internet.
echo.
echo Sélectionnez l'exploit:
echo.
echo 1: Version du système 5.5.0 ou 5.5.1?
echo 2: Version du système 5.5.2 ou 5.5.3?
echo 3: Version du système 5.5.2 ou 5.5.3 (plus stable mais nécessite de copier un fichier sur la SD pour fonctionner)?
echo 0: Termine le script.
echo.
set /p choose_exploit=Entrez le chiffre correspondant à la version de votre système Wii U: 
call TOOLS\Storage\functions\strlen.bat nb "%choose_exploit%"
IF %nb% EQU 0 (
	echo Cette valeur  ne peut être vide. Réessayez.
	goto:set_choose_exploit
)
set "choose_exploit=%choose_exploit:~0,1%"
set nb=1
set i=0
:check_chars_choose_exploit
IF %i% LSS %nb% (
	set check_chars_choose_exploit=0
	FOR %%z in (0 1 2 3) do (
		IF "!choose_exploit:~%i%,1!"=="%%z" (
			set /a i+=1
			set check_chars_choose_exploit=1
			goto:check_chars_choose_exploit
		)
	)
	IF "!check_chars_choose_exploit!"=="0" (
		echo Vous devez choisir une des valeurs permisent. 
		set choose_exploit=
		goto:set_choose_exploit
	)
)
		IF "%choose_exploit%"=="0" goto:endscript
ipconfig | TOOLS\gnuwin32\bin\grep.exe "Adresse IPv4" | TOOLS\gnuwin32\bin\cut.exe -d : -f 2 > templogs\IPs_list.txt
TOOLS\gnuwin32\bin\grep.exe -c "" <templogs\IPs_list.txt >templogs\count.txt
set /p tempcount=<templogs\count.txt
del /q templogs\count.txt
IF "%tempcount%"=="0" (
	echo Aucune adresse IP V4 trouvée. Veuillez vous assuré d'être connecté à votre réseau. 
	echo Le script va maintenant s'arrêté. 
	goto:endscript
)
echo. 
echo Liste des adresse IP possibles: 
:list_IPs
IF "%tempcount%"=="0" goto:skip_list_IPs
TOOLS\gnuwin32\bin\tail.exe -%tempcount% <templogs\IPs_list.txt | TOOLS\gnuwin32\bin\head.exe -1
set /a tempcount-=1
goto:list_IPs
:skip_list_IPs
echo.
echo Vous devrez entrer une des adresses IP ci-dessus dans la barre d'adresse du navigateur internet de votre console pour lancer l'exploit.
echo N'oubliez pas d'autoriser également l'application si cela est demandée par votre pare-feu.
echo.
echo Pour terminer l'exécution du serveur, vous devrez appuyer sur "ctrl+c" ou fermer sa fenêtre.
pause 
IF "%choose_exploit%"=="1" (
	start tools\web_exploits\caddy.exe -agree -http-port 80 -https-port 443 -port 80 -root tools\web_exploits\5.5.1
	goto:endscript
) else IF "%choose_exploit%"=="2" (
	start tools\web_exploits\caddy.exe -agree -http-port 80 -https-port 443 -port 80 -root tools\web_exploits\5.5.2
	goto:endscript
)
:define_choose_payload_copy
IF "%choose_exploit%"=="3" (
	echo Attention, l'exploit choisi nécessite d'avoir le fichier "payload.elf" copié dans le dossier "wiiu" de la carte SD. Si la SD a été préparée avec mon script en version 1.67 ou supérieur, ce fichier est déjà présent. Si tel n'est pas le cas, la suite du script vous proposera de le copier.
	echo.
	set /p choose_payload_copy=Souhaitez-vous copier le payload sur la SD? (O/n^): 
)
IF NOT "%choose_payload_copy%"=="" set choose_payload_copy=%choose_payload_copy:~0,1%
IF "%choose_exploit%"=="3" (
	IF /i "%choose_payload_copy%"=="o" (
	goto:copy_exploit_3_payload
	) else (
		goto:launch_exploit_3
	)
)
:copy_exploit_3_payload
:define_volume_letter
%windir%\system32\wscript //Nologo //B TOOLS\Storage\functions\list_volumes_fat32.vbs
TOOLS\gnuwin32\bin\grep.exe -c "" <templogs\volumes_list.txt >templogs\count.txt
set /p tempcount=<templogs\count.txt
del /q templogs\count.txt
IF "%tempcount%"=="0" (
	echo Aucun disque compatible trouvé.
	echo.
	goto:define_choose_payload_copy
)
echo.
echo Liste des disques:
:list_volumes
IF "%tempcount%"=="0" goto:set_volume_letter
TOOLS\gnuwin32\bin\tail.exe -%tempcount% <templogs\volumes_list.txt | TOOLS\gnuwin32\bin\head.exe -1
set /a tempcount-=1
goto:list_volumes
:set_volume_letter
echo.
echo.
set /p volume_letter=Entrez la lettre du volume de la SD que vous souhaitez utiliser:
call TOOLS\Storage\functions\strlen.bat nb "%volume_letter%"
IF %nb% EQU 0 (
	echo La lettre de lecteur ne peut être vide. Réessayez.
	goto:define_volume_letter
)
set volume_letter=%volume_letter:~0,1%
set nb=1
CALL TOOLS\Storage\functions\CONV_VAR_to_MAJ.bat volume_letter
set i=0
:check_chars_volume_letter
IF %i% LSS %nb% (
	set check_chars_volume_letter=0
	FOR %%z in (A B C D E F G H I J K L M N O P Q R S T U V W X Y Z) do (
		IF "!volume_letter:~%i%,1!"=="%%z" (
			set /a i+=1
			set check_chars_volume_letter=1
			goto:check_chars_volume_letter
		)
	)
	IF "!check_chars_volume_letter!"=="0" (
		echo Un caractère non autorisé a été saisie dans la lettre du lecteur. Recommencez.
		set volume_letter=
		goto:define_volume_letter
	)
)
IF NOT EXIST "%volume_letter%:\" (
	echo Ce volume n'existe pas. Recommencez.
	set volume_letter=
	goto:define_volume_letter
)
TOOLS\gnuwin32\bin\grep.exe "Lettre volume=%volume_letter%" <templogs\volumes_list.txt | TOOLS\gnuwin32\bin\cut.exe -d ; -f 1 | TOOLS\gnuwin32\bin\cut.exe -d = -f 2 > templogs\tempvar.txt
set /p temp_volume_letter=<templogs\tempvar.txt
IF NOT "%volume_letter%"=="%temp_volume_letter%" (
	echo Cette lettre de volume n'est pas dans la liste. Recommencez.
	goto:define_volume_letter
)
IF NOT EXIST "%volume_letter%:\wiiu\*.*" mkdir "%volume_letter%:\wiiu"
copy /v "TOOLS\web_exploits\5.5.2_new\payload\payload.elf" "%volume_letter%:\wiiu\payload.elf"
:launch_exploit_3
IF "%choose_exploit%"=="3" (
	start tools\web_exploits\caddy.exe -agree -http-port 80 -https-port 443 -port 80 -root tools\web_exploits\5.5.2_new
	)
:endscript
rmdir /s /q templogs
endlocal